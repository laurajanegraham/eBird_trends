---
title: "eBird Occupancy Model Testing"
author: "Laura Graham"
date: "July 21, 2016"
output: 
  pdf_document:
    number_sections: true
---
```{r setup, message=FALSE, include=FALSE}
library(R2jags)
library(snowfall)
library(abind)
library(R2WinBUGS)
load("locations_sml.rda")
load("locations_full.rda")
```

# Data preparation
Currently working with the data for hummingbirds from Colorado. The dataset has been generated in Python and I have filtered it such that only locations which have greater than 3 observations in at least one month are included. This reduces the number of locations from `r nrow(locations_full)` to `r nrow(locations_sml)`. 

The final data output from Python is a 4-dimensional array where the dimensions are: Year, Location, Species and Replicate. 

```{r load_data}
load("data/hummingbirds_colorado.rda")

# size of array
dim(all_dat$sp_obs)
```

# Initial models
## Basic dynamic occupancy model (no covariates)

Firstly, we want to fit a model with no covariates and get some initial parameter estimates out.

```{r basic_model, eval = FALSE}
# Code modified from Kery and Schaub 2012
# Bundle data
all_dat$sp_obs[is.nan(all_dat$sp_obs)] <- NA # data comes out of SQL/Python with missing values coded as NaN - causes issues in JAGS
nyear <- dim(all_dat$sp_obs)[1]
#nsite <- dim(all_dat$sp_obs)[2]
nsite <- 40 # make it run quicker for initial testing
nspecies <- dim(all_dat$sp_obs)[3]
#nrep <-  dim(wide_dat)[4]
nrep <- 10 # again, quicker for testing 
nparam <- 2
dat <- list(y = all_dat$sp_obs, nyear = nyear, nsite = nsite, nspecies = nspecies, nrep = nrep, effort_hrs = all_dat$effort_hrs, day = all_dat$day, nparam = nparam)

# Initial values
zst <- apply(all_dat$sp_obs, c(1, 2, 3), max, na.rm=TRUE)	# Observed occurrence as inits for z
zst[is.infinite(zst)] <- NA
zst <- zst[,1:40,]
inits <- function(){ list(z = zst)}
# Parameters monitored
params <- c("psi", "phi", "gamma", "p", "alphap", "betap", "wp")

# MCMC settings
ni <- 2500
nt <- 4
nb <- 500
nc <- 3

# Call JAGS from R
strt <- Sys.time()

source("code/JAGSParallel.R")
out <- JAGSParallel(n.cores = 3, data = dat, inits = inits, params = params, model.file = "code/dynocc_covs.JAGS.R", n.chains = nc, n.thin = nt, n.iter = ni, n.burnin = nb)

save(out, file="covs_model.Rda")

print(Sys.time() - strt)
print(out$JAGSoutput, digits=3)
```

## Dynamic occupany model correcting for detection bias. 
This model has covariates on the observation model and uses indicator variable selection to identify important parameters. Full set of parameters included is:

- time
- effort_hrs
- day
- year
- population per sq mile
- housing density
- number of observers

```{r}
# Code modified from Kery and Schaub 2012
# Bundle data
wide_dat[is.nan(wide_dat)] <- NA
dat <- list(y = wide_dat, nyear = dim(wide_dat)[1], nsite = dim(wide_dat)[2], nspecies = dim(wide_dat)[3], nrep = dim(wide_dat)[4])

# Initial values
zst <- apply(wide_dat, c(1, 2, 3), max, na.rm=TRUE)	# Observed occurrence as inits for z
zst[is.infinite(zst)] <- NA
inits <- function(){ list(z = zst)}
# Parameters monitored
params <- c("psi", "phi", "gamma", "p", "n.occ", "growthr", "turnover")

# MCMC settings
ni <- 2500
nt <- 4
nb <- 500
nc <- 3

# Call JAGS from R
strt <- Sys.time()

source("code/JAGSParallel.R")
out <- JAGSParallel(n.cores = 3, data = dat, inits = inits, params = params, model.file = "code/dynocc.JAGS.R", n.chains = nc, n.thin = nt, n.iter = ni, n.burnin = nb)

save(out, file="basic_model.Rda")

print(Sys.time() - strt)
print(out$JAGSoutput, digits=3)
```

